{% extends 'base.html' %}
{% block title %}Visualizar tarefas{% endblock %}
{% block content %}
  <h1 class="text-center">Visualização de Tarefas</h1>
  <table class="table table-striped table-hover mt-3">
    <thead>
      <tr>
        <th scope="col">Criado em</th>
        <th scope="col">Tipo</th>
        <th scope="col">Nome</th>
        <th scope="col">Status</th>
        <th scope="col">Prazo</th>
        <th scope="col">Possui Lembrete?</th>
        <th scope="col">Ações</th>
      </tr>
    </thead>
    <tbody>
        {% for tarefa in tarefas %}
      <tr>
        <th scope="row">{{ tarefa.criado_em|date:"d/m/Y H:i" }}</th>
        <td>{{ tarefa.tipo }}</td>
        <td>{{ tarefa.nome }}</td>
        <td>{{ tarefa.status }}</td>
        <td>{{ tarefa.prazo|default:"Sem data" }}</td>
        <td>{% if tarefa.com_lembrete %}Sim{% else %}Não{% endif %}</td>
        <td >
            <div class="d-flex gap-1">  
            <a href="{% url 'concluir_tarefa' tarefa.id %}" class="btn btn-success disable-on-submit">
              <i class="bi bi-check-circle-fill"></i>
            </a>
            <a href="#" class="btn btn-primary disable-on-submit" data-tarefa-id="{{ tarefa.id }}" data-bs-toggle="modal" data-bs-target="#modalVisualizacaoConfirmarAcao">
              <i class="bi bi-eye-fill"></i>
            </a>
            <a href="#" class="btn btn-secondary" data-tarefa-id="{{ tarefa.id }}" data-bs-toggle="modal" data-bs-target="#modalEdicaoTarefa">
              <i class="bi bi-pencil-fill"></i>
            </a>
            <a href="#" class="btn btn-danger disable-on-submit abrirModalExclusao" data-tarefa-id="{{ tarefa.id }}" data-bs-toggle="modal" data-bs-target="#modalVisualizacaoConfirmarAcao">
              <i class="bi bi-x-circle-fill"></i>
            </a>
            </div>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan=7 class="text-center">Não existem tarefas cadastradas com as especificações selecionadas</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="modal fade" id="modalVisualizacaoConfirmarAcao" tabindex="-1" aria-labelledby="confirmarAcao" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="tituloModal"></h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Criado em: <strong id="criadoEm"></strong></p>
          <p>Tipo: <strong id="tipo"></strong></p>
          <p>Status: <strong id="status"></strong></p>
          <p>Prazo: <strong id="prazo"></strong></p>
          <p>Prioridade: <strong id="prioridade"></strong></p>
          <p>Concluído em: <strong id="concluidoEm"></strong></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <button type="button" class="d-none btn" id="botaoVisualizarConfirmarAcao">Excluir</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalEdicaoTarefa" tabindex="-1" aria-labelledby="modalEdicaoTarefa" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      
      <div class="modal-content">
        <form id="formEdicaoTarefa" action="#" data-url-base="/tarefas/editar-tarefa/" method="POST">
        {% csrf_token %}
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="tituloModalEdicao">Edição de tarefa</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        
        <div class="modal-body">
            {{ form }}          
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <button type="submit" class="btn btn-success" id="botaoEditarTarefa">Confirmar Alterações</button>
        </div>
        </form>
      </div>
    
    </div>
  </div>

  {% csrf_token %}

  <script>
    // Variável global para o token CSRF (lido uma vez)
    const CSRF_TOKEN = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Funções Auxiliares
    function formatarData(dataApi){
      const data = new Date(dataApi);
      const opcoesDeData = {
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric',  
        hour: '2-digit',  
        minute: '2-digit',
        hour12: false,  
        timeZone: 'America/Sao_Paulo' 
      };
      const formatador = new Intl.DateTimeFormat('pt-BR', opcoesDeData);
      return formatador.format(data);
    }
    
    // Função Centralizada para FETCH
    function consultarDadosTarefa(idTarefa) {
      const urlConsulta = `/tarefas/api-consultar-tarefa/${idTarefa}`;
      
      return fetch(urlConsulta, {
        headers: {
            'Content-Type': 'application/json', 
            'X-CSRFToken': CSRF_TOKEN,
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Erro ao fazer requisição: ' + response.statusText);
        }
        return response.json();
      });
    }

    // --- Lógica de Visualização e Exclusão ---
    
    function exibirDetalhesDaTarefa(json, botaoAcionador, botaoConfirmacaoElemento){
      const isExclusao = botaoAcionador.classList.contains('abrirModalExclusao');
      const tituloModal = document.getElementById('tituloModal');
      
      // Mapeamento dos campos
      document.getElementById('criadoEm').textContent = formatarData(json.criado_em);
      document.getElementById('tipo').textContent = json.tipo;
      document.getElementById('status').textContent = json.status;
      document.getElementById('prioridade').textContent = json.prioridade;

      if (json.concluido_em){
        document.getElementById('concluidoEm').textContent = formatarData(json.concluido_em);
      }else{
        document.getElementById('prazo').textContent = "Sem data";
      }

      if (json.prazo){
        document.getElementById('prazo').textContent = formatarData(json.prazo);
      }else{
        document.getElementById('prazo').textContent = "Sem data";
      }

      // Lógica Condicional (Exclusão vs. Visualização)
      if (isExclusao){
        tituloModal.textContent = `Confirma a exclusão da tarefa ${json.nome}?`;
        botaoConfirmacaoElemento.classList.replace('d-none', 'btn-danger');
        botaoConfirmacaoElemento.textContent = "Excluir";
      }else{
        tituloModal.textContent = `Detalhes da tarefa ${json.nome}`;
        botaoConfirmacaoElemento.classList.add('d-none');
        botaoConfirmacaoElemento.classList.remove('btn-danger');
      }
    }
    
    // --- Lógica de Edição ---

    // Função para preencher o formulário (Edição)
    function preencherFormularioEdicao(json, formElement) {
        // Preenche cada campo do formulário com o JSON retornado
        formElement.querySelector('#id_tipo').value = json.tipo
        formElement.querySelector('#id_prioridade').value = json.prioridade
        if (json.nome) formElement.querySelector('#id_nome').value = json.nome;
        if (json.status) formElement.querySelector('#id_status').value = json.status;
        if (json.prazo){
          formElement.querySelector('#id_prazo').value = json.prazo;
        } else{
          formElement.querySelector('#id_prazo').value = ""
        }        
        document.getElementById('tituloModalEdicao').textContent = `Editando: ${json.nome}`;
    }

    // --- Event Listeners Principais ---

    document.addEventListener('DOMContentLoaded', (event)=>{
      const modalVisualizacao = document.getElementById('modalVisualizacaoConfirmarAcao');
      const botaoAcao = document.getElementById('botaoVisualizarConfirmarAcao');

      // 1. OTIMIZAÇÃO: Listener para LIMPEZA IMEDIATA (Anti-Flicker)
      modalVisualizacao.addEventListener('show.bs.modal', (event) => {
          // Garante que o botão de exclusão esteja escondido ANTES da animação
          botaoAcao.classList.add('d-none');
          botaoAcao.classList.remove('btn-danger');
          
          // Anexa o listener de exclusão AQUI (para ter acesso ao idTarefa correto)
          const botao = event.relatedTarget;
          const idTarefa = botao.dataset.tarefaId;

          botaoAcao.onclick = function() {
             window.location.href = `/tarefas/excluir-tarefa/${idTarefa}`;
          };
      });


      // 2. Listener para PROCESSAMENTO (Fetch de Dados)
      modalVisualizacao.addEventListener('shown.bs.modal', (event)=>{
        const botao = event.relatedTarget;
        const idTarefa = botao.dataset.tarefaId;

        consultarDadosTarefa(idTarefa)
        .then(json =>{
          exibirDetalhesDaTarefa(json, botao, botaoAcao);
        })
        .catch(error =>{
          console.log('Erro durante a requisição ', error);
          alert('Falha ao carregar detalhes da tarefa.');
        });
        
      });

      // 3. Listener para Modal de Edição
      const modalEdicao = document.getElementById('modalEdicaoTarefa');
      const formEdicao = document.getElementById('formEdicaoTarefa');

      modalEdicao.addEventListener('shown.bs.modal', (event)=>{
        const botao = event.relatedTarget;
        const tarefaId = botao.dataset.tarefaId;
        
        // 3a. Ajustar a URL de Ação do Formulário
        const urlBase = formEdicao.dataset.urlBase;
        formEdicao.action = `${urlBase}${tarefaId}/`;

        // 3b. Fetch e Preenchimento
        consultarDadosTarefa(tarefaId)
        .then(json => {
            preencherFormularioEdicao(json, formEdicao);
        })
        .catch(error => {
            console.log('Erro durante a requisição de edição: ', error);
            alert('Falha ao carregar dados da tarefa para edição.');
        });
      });
    });
  </script>
{% endblock %}